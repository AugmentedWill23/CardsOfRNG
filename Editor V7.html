<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Rarity Roll Game – Deep Battle, Deck Building, Daily Challenges & Appraisal</title>
    <style>
        /* Global Styles and Background */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            margin: 0;
            padding: 0;
            transition: background 0.3s;
        }

        /* Container for centers */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.7);
        }

        /* Common Styles */
        h1, h2 {
            margin: 20px 0;
            text-align: center;
        }

        /* Login / Sign Up Screen */
        #loginScreen,
        #gameScreen {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Input Fields */
        input {
            padding: 12px;
            margin: 10px 0;
            width: calc(100% - 20px);
            border-radius: 5px;
            border: 1px solid #fff;
            font-size: 16px;
            outline: none;
            transition: border 0.3s;
        }

        input:focus {
            border-color: #ffa500;
        }

        /* Button Styles */
        button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #ffa500;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            width: 100%;
            margin: 10px 0;
        }

        button:hover {
            background-color: #ff8c00;
        }

        /* Main Game Screen */
        #gameScreen {
            display: none;
        }

        header,
        footer {
            text-align: center;
            margin-bottom: 20px;
        }

        footer p {
            margin: 5px 0;
        }

        /* Tab Navigation */
        nav {
            text-align: center;
            margin-bottom: 20px;
        }

        nav .tabButton {
            background-color: #fff;
            color: #333;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        nav .tabButton:hover {
            background-color: #ddd;
        }

        nav .tabButton.active {
            background-color: #ffa500;
            color: #fff;
        }

        /* Result / Roll Box with fade-in effect */
        .resultBox {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            opacity: 0;
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        /* List Styling */
        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        /* Card Flip Style */
        .card {
            perspective: 1000px;
            width: 300px;
            margin: 0 auto;
        }

        .card-inner {
            width: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            backface-visibility: hidden;
            border: 2px solid #fff;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* Improved display styles */
        .tabContent {
            display: none;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .tabContent.active {
            display: block;
        }

        /* Animation and styling for cases */
        #caseAnimation {
            display: flex;
            overflow: hidden;
            width: 100%;
            height: 200px;
            position: relative;
            border: 1px solid #fff;
            border-radius: 5px;
            margin-bottom: 10px;
            animation: spin 5s infinite linear;
        }

        #caseAnimation .item {
            flex: 0 0 auto;
            width: 100px;
            height: 100px;
            margin: auto;
            text-align: center;
            line-height: 100px;
            font-size: 16px;
            color: #fff;
        }

        @keyframes spin {
            from {
                transform: rotateY(0deg);
            }

            to {
                transform: rotateY(360deg);
            }
        }

        /* Upgrade buttons */
        .upgrade-button {
            text-align: center;
            display: block;
            margin: 10px auto;
        }

        /* Styles for Filters */
        #filters {
            margin-bottom: 20px;
            text-align: center;
        }

        #filters select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #fff;
            margin: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <button id="toggleUI" onclick="toggleUI()">Switch to Computer UI</button>

        <div id="loginScreen">
            <h2>Login / Sign Up</h2>
            <form id="loginForm">
                <input type="text" id="usernameInput" placeholder="Username" required>
                <input type="password" id="passwordInput" placeholder="Password" required>
                <label><input type="radio" name="action" value="login" checked> Login</label>
                <label><input type="radio" name="action" value="signup"> Sign Up</label>
                <button type="submit">Submit</button>
            </form>
        </div>

        <div id="gameScreen">
            <header>
                <h1>Rarity Roll Game – Enhanced Experience</h1>
                <p id="userGreeting">Welcome, User</p>
                <p id="totalPowerDisplay">Total Power: <span id="totalPower">0</span></p>
                <button id="logoutBtn">Logout</button>
                <button id="deleteDataBtn">Delete Data</button>
                <p id="currencyDisplay">Coins: <span id="currency">100</span></p>
            </header>

            <nav>
                <button id="rollTab" class="tabButton active" onclick="showTab('roll')">Roll</button>
                <button id="deckTab" class="tabButton" onclick="showTab('deck')">Deck</button>
                <button id="inventoryTab" class="tabButton" onclick="showTab('inventory')">Inventory</button>
                <button id="appraisalTab" class="tabButton" onclick="showTab('appraisal')">Appraisal</button>
                <button id="upgradesTab" class="tabButton" onclick="showTab('upgrades')">Upgrades/Potions</button>
                <button id="casesTab" class="tabButton" onclick="showTab('cases')">Cases</button>
                <button id="battleTab" class="tabButton" onclick="showTab('battle')">Battle</button>
                <button id="leaderboardTab" class="tabButton" onclick="showTab('leaderboard')">Leaderboard</button>
                <button id="dailyTab" class="tabButton" onclick="showTab('daily')">Daily Challenges</button>
            </nav>

            <main>
                <!-- Filters Section -->
                <div id="filters">
                    <h3>Filter Rarities</h3>
                    <label for="rarityFilter">Choose Rarity:</label>
                    <select id="rarityFilter" onchange="filterRarities()">
                        <option value="">All</option>
                        <option value="common">Common</option>
                        <option value="uncommon">Uncommon</option>
                        <option value="rare">Rare</option>
                        <option value="epic">Epic</option>
                        <option value="legendary">Legendary</option>
                        <option value="mythic">Mythic</option>
                        <option value="divine">Divine</option>
                        <option value="cosmic">Cosmic</option>
                        <option value="eternal">Eternal</option>
                        <option value="celestial">Celestial</option>
                        <option value="transcendent">Transcendent</option>
                        <option value="godly">Godly</option>
                        <option value="extreme">Extreme</option>
                        <option value="solar">Solar</option>
                        <option value="galactic">Galactic</option>
                        <option value="universal">Universal</option>
                        <option value="mythos">Mythos</option>
                        <option value="primal">Primal</option>
                        <option value="ethereal">Ethereal</option>
                        <option value="restricted">Restricted</option>
                    </select>
                </div>

                <!-- Roll Tab -->
                <section id="rollContent" class="tabContent active">
                    <div id="rollInstructions">
                        <p>Click "Roll for Card" to try your luck. Each roll gives you a collectible card with unique stats
                            and a dynamically generated ability (including numeric modifier, cooldown rounds, and an effect
                            type). Note the cooldown between rolls.</p>
                    </div>
                    <button id="rollButton">Roll for Card</button>
                    <p id="cooldownTimer"></p>
                    <div id="rollResult" class="resultBox"></div>
                    <button id="flipCardBtn" style="display:none;">Flip Card</button>
                    <p id="boostStatus"></p>
                    <div id="rarityList" style="border: 1px solid #fff; padding: 10px; border-radius: 5px;">
                        <h3>Rarity List</h3>
                        <ul id="rarityRolledList">
                            <li>Common (15%)</li>
                            <li>Uncommon (10%)</li>
                            <li>Rare (7.5%)</li>
                            <li>Epic (5%)</li>
                            <li>Legendary (4%)</li>
                            <li>Mythic (3%)</li>
                            <li>Divine (2%)</li>
                            <li>Cosmic (1%)</li>
                            <li>Eternal (0.1%)</li>
                            <li>Celestial (0.01%)</li>
                            <li>Transcendent (0.001%)</li>
                            <li>Godly (0.0001%)</li>
                            <li>Extreme (0.00001%)</li>
                            <li>Solar (0.00005%)</li>
                            <li>Galactic (0.00003%)</li>
                            <li>Universal (0.000001%)</li>
                            <li>Mythos (0.000005%)</li>
                            <li>Primal (0.000002%)</li>
                            <li>Ethereal (0.0000001%)</li>
                            <li>Restricted (0.00000005%)</li>
                        </ul>
                    </div>
                </section>

                <!-- Deck Builder Tab -->
                <section id="deckContent" class="tabContent">
                    <h2>Deck Builder</h2>
                    <p>Select up to 5 cards from your inventory to build your battle deck.</p>
                    <div id="deckBuilder">
                        <h3>Inventory Cards</h3>
                        <ul id="deckInventoryList"></ul>
                    </div>
                    <div id="currentDeck">
                        <h3>Your Deck</h3>
                        <ul id="deckList"></ul>
                    </div>
                </section>

                <!-- Inventory Tab -->
                <section id="inventoryContent" class="tabContent">
                    <h2>Your Inventory</h2>
                    <ul id="inventoryList"></ul>
                </section>

                <!-- Appraisal Tab -->
                <section id="appraisalContent" class="tabContent">
                    <h2>Appraisal</h2>
                    <p>Select a card from your inventory to appraise. Paying 500 coins will increase its value by 50% and
                        give it a chance to improve its grade and quality.</p>
                    <ul id="appraisalList"></ul>
                </section>

                <!-- Upgrades / Potions Tab -->
                <section id="upgradesContent" class="tabContent">
                    <h2>Upgrades and Potions</h2>
                    <p id="cooldownLevelDisplay">Cooldown Upgrade Level: 0</p>
                    <p id="luckLevelDisplay">Luck Upgrade Level: 0</p>
                    <p id="currentCooldownDisplay">Current Roll Cooldown: 5.0s</p>
                    <button id="upgradeCooldownBtn">Upgrade Roll Speed (Cost: 50 Coins)</button>
                    <button id="upgradeLuckBtn">Upgrade Luck (Cost: 100 Coins)</button>
                    <hr>
                    <p>Potions:</p>
                    <p>Luck Potions: <span id="luckPotionCount">0</span></p>
                    <button id="buyLuckPotionBtn">Buy Luck Potion (100 Coins)</button>
                    <button id="useLuckPotionBtn">Use Luck Potion</button>
                    <br>
                    <p>Speed Potions: <span id="speedPotionCount">0</span></p>
                    <button id="buySpeedPotionBtn">Buy Speed Potion (120 Coins)</button>
                    <button id="useSpeedPotionBtn">Use Speed Potion</button>
                    <br>
                    <p>Battle Potions: <span id="battlePotionCount">0</span></p>
                    <button id="buyBattlePotionBtn">Buy Battle Potion (150 Coins)</button>
                    <button id="useBattlePotionBtn">Use Battle Potion</button>
                    <br>
                    <p id="potionStatus"></p>
                </section>

                <!-- Cases Tab -->
                <section id="casesContent" class="tabContent">
                    <h2>Cases</h2>
                    <p>Select a case to open and get cards (and potions) with different odds.</p>
                    <div id="caseAnimation"></div>
                    <button id="openBasicCaseBtn">Open Basic Case (100 Coins)</button>
                    <button id="openPremiumCaseBtn">Open Premium Case (200 Coins)</button>
                    <button id="openUltraCaseBtn">Open Ultra Case (400 Coins)</button>
                    <button id="openEliteCaseBtn">Open Elite Case (800 Coins)</button>
                    <button id="openLegendaryCaseBtn">Open Legendary Case (1200 Coins)</button>
                    <div id="caseResult" class="resultBox"></div>
                </section>

                <!-- Battle Tab -->
                <section id="battleContent" class="tabContent">
                    <h2>Battle</h2>
                    <p>Use your deck (build it in the Deck Builder) to battle enemy decks in turn-based combat with special
                        abilities, synergy effects, and dynamic ability modifiers!</p>
                    <button id="startBattleBtn">Start Battle</button>
                    <div id="battleResult" class="resultBox"></div>
                    <div id="turnLog" style="white-space: pre-wrap;"></div>
                    <button id="nextTurnBtn" style="display: none;">Next Turn</button>
                </section>

                <!-- Leaderboard Tab -->
                <section id="leaderboardContent" class="tabContent">
                    <h2>Leaderboard</h2>
                    <p id="playerScoreDisplay">Player Score: 0</p>
                    <ul id="leaderboardList"></ul>
                </section>

                <!-- Daily Challenges Tab -->
                <section id="dailyContent" class="tabContent">
                    <h2>Daily Challenges</h2>
                    <div id="dailyChallengeInfo"></div>
                    <button id="claimDailyChallengeBtn" style="display:none;">Claim Daily Reward</button>
                    <button id="generateNewChallengeBtn">Generate New Challenge</button>
                </section>
            </main>

            <footer>
                <p>
                    Instructions: Roll for cards (each with dynamic abilities including numeric modifiers, cooldown rounds,
                    and an effect type). Build your deck in the Deck Builder. Manage your inventory by selling cards for
                    coins. Use the Appraisal tab to pay 500 coins to increase a card's value by 50% and (with a 50% chance
                    each) raise its grade and/or quality. Open cases, upgrade roll speed and luck, use potions, battle enemy decks,
                    and complete daily challenges for extra rewards!
                </p>
            </footer>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="rollSound" src="roll.mp3"></audio>
    <audio id="sellSound" src="sell.mp3"></audio>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // UI Mode
            let isComputerUI = false;

            document.getElementById('toggleUI').addEventListener('click', toggleUI);

            function toggleUI() {
                isComputerUI = !isComputerUI; // Toggle between UI modes
                const body = document.body;
                body.classList.toggle('computer-ui', isComputerUI); // Apply computer styles
                document.getElementById('toggleUI').innerText = isComputerUI
                    ? "Switch to Mobile UI"
                    : "Switch to Computer UI"; // Toggle button text
            }

            // ---------------- Account & Save System -------------------------
            let currentUser = null;
            let userData = {};
            let globalCardId = 0; // Global counter to assign unique IDs to cards.

            // Define grade and quality orders (worst to best).
            const grades = ["E", "D", "C", "B", "A", "S", "SS"];
            const qualities = ["destroyed", "ripped", "crumpled", "creased", "Mint condition"];

            // Define new rarities to add with probabilities
            const rarities = [
                { name: "common", prob: 15 }, { name: "uncommon", prob: 10 },
                { name: "rare", prob: 7.5 }, { name: "epic", prob: 5 },
                { name: "legendary", prob: 4 }, { name: "mythic", prob: 3 },
                { name: "divine", prob: 2 }, { name: "cosmic", prob: 1 },
                { name: "eternal", prob: 0.1 }, { name: "celestial", prob: 0.01 },
                { name: "transcendent", prob: 0.001 }, { name: "godly", prob: 0.0001 },
                { name: "extreme", prob: 0.00001 }, { name: "solar", prob: 0.00005 },
                { name: "galactic", prob: 0.00003 }, { name: "universal", prob: 0.000001 },
                { name: "mythos", prob: 0.000005 }, { name: "primal", prob: 0.000002 },
                { name: "ethereal", prob: 0.0000001 }, { name: "restricted", prob: 0.00000005 }
            ];

            // Ensure daily challenge is refreshed each day.
            function initializeDailyChallenge() {
                const today = new Date().toLocaleDateString();
                if (!userData.dailyChallenge || userData.dailyChallenge.date !== today) {
                    userData.dailyChallenge = {
                        date: today,
                        wins: 0,
                        target: Math.floor(Math.random() * 3) + 3, // New target between 3 to 5
                        reward: (Math.floor(Math.random() * 100) + 50), // Randomized 50 to 150 coins reward
                        claimed: false,
                        description: "Win " + Math.floor(Math.random() * 10 + 1) + " battles."
                    };
                }
            }

            // Save current user's data.
            function saveUserData() {
                if (currentUser) {
                    localStorage.setItem("user_" + currentUser, JSON.stringify(userData));
                }
            }

            // Calculate total power.
            function calculateTotalPower() {
                let total = userData.playerScore || 0;
                (userData.inventory || []).forEach(card => {
                    total += (card.attack + card.defense);
                });
                return total;
            }

            function updateUserHeader() {
                document.getElementById("userGreeting").innerText = "Welcome, " + currentUser;
                document.getElementById("totalPowerDisplay").innerText = "Total Power: " + calculateTotalPower();
            }

            // Login / Signup handling.
            document.getElementById("loginForm").addEventListener("submit", function (e) {
                e.preventDefault();
                let username = document.getElementById("usernameInput").value.trim();
                let password = document.getElementById("passwordInput").value;
                let action = document.querySelector('input[name="action"]:checked').value;
                if (!username || !password) {
                    alert("Please fill in both fields.");
                    return;
                }
                if (action === "login") {
                    let storedData = localStorage.getItem("user_" + username);
                    if (!storedData) {
                        alert("User does not exist. Please sign up.");
                        return;
                    }
                    let storedUser = JSON.parse(storedData);
                    if (storedUser.password !== password) {
                        alert("Incorrect password.");
                        return;
                    }
                    currentUser = username;
                    userData = storedUser;
                    initializeDailyChallenge();
                    loginSuccess();
                } else if (action === "signup") {
                    if (localStorage.getItem("user_" + username)) {
                        alert("Username already exists. Please choose another.");
                        return;
                    }
                    userData = {
                        username: username,
                        password: password,
                        currency: 100,
                        playerScore: 0,
                        cooldownLevel: 0,
                        luckUpgradeLevel: 0,
                        inventory: [],
                        deck: [],
                        potions: {
                            luck: 0,
                            speed: 0,
                            battle: 0
                        }
                    };
                    currentUser = username;
                    initializeDailyChallenge();
                    saveUserData();
                    loginSuccess();
                }
            });

            function loginSuccess() {
                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("gameScreen").style.display = "block";
                updateUserHeader();
                updateUI();
            }

            function logout() {
                saveUserData();
                currentUser = null;
                userData = {};
                document.getElementById("gameScreen").style.display = "none";
                document.getElementById("loginScreen").style.display = "block";
            }

            function deleteData() {
                if (confirm("Are you sure you want to delete your data? This cannot be undone.")) {
                    localStorage.removeItem("user_" + currentUser);
                    alert("Data deleted. You will now be logged out.");
                    logout();
                }
            }

            document.getElementById("logoutBtn").addEventListener("click", logout);
            document.getElementById("deleteDataBtn").addEventListener("click", deleteData);

            // ---------------- Game Variables ---------------------------
            let isRolling = false;
            let luckActive = false;
            let speedBoostActive = false;
            let battleBoostActive = false;
            const baseCooldown = 5000; // ms
            const cooldownReduction = 500;
            const minCooldown = 1000;
            const boostDuration = 30; // sec
            let luckTimeRemaining = 0;
            let speedTimeRemaining = 0;
            let luckTimerInterval, speedTimerInterval;

            const rollSound = document.getElementById("rollSound");
            const sellSound = document.getElementById("sellSound");

            // ---------------- Rarities & Items Setup -------------------------
            let items = {}; // Organized by rarity
            rarities.forEach(rarity => {
                items[rarity.name] = [];
            });

            // Generate items for each rarity
            rarities.forEach(rarityData => {
                for (let i = 1; i <= (itemCounts[rarityData.name] || 1); i++) {
                    let range = statsRanges[rarityData.name];
                    let baseAttack = getRandomInt(range.min, range.max);
                    let baseDefense = getRandomInt(range.min, range.max);

                    // Randomly generate grade and quality
                    let grade = grades[getRandomInt(0, grades.length - 1)];
                    let quality = qualities[getRandomInt(0, qualities.length - 1)];

                    // Apply multipliers based on randomly generated grade and quality
                    let attack = Math.floor(baseAttack * gradeMultipliers[grade] * qualityMultipliers[quality]);
                    let defense = Math.floor(baseDefense * gradeMultipliers[grade] * qualityMultipliers[quality]);

                    items[rarityData.name].push({
                        id: getRandomInt(1, 10000), // Temporary unique id
                        name: `${capitalize(rarityData.name)} Card ${i}`,
                        value: getRandomInt(10, 50) + i,
                        description: `A ${rarityData.name} collectible card with Grade: ${grade} and Quality: ${quality}.`,
                        ability: generateRandomAbility(),
                        attack: attack,
                        defense: defense,
                        rarity: rarityData.name,
                        grade: grade,
                        quality: quality,
                        probability: rarityData.prob // Store probability for display
                    });
                }
            });

            // --------------- Helper Functions ---------------------------
            function capitalize(s) {
                return s.charAt(0).toUpperCase() + s.slice(1);
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            // --------------- UI Update Functions ---------------------------
            function updateUI() {
                // Dynamically update coins
                document.getElementById("currencyDisplay").innerText = "Coins: " + userData.currency;

                document.getElementById("cooldownLevelDisplay").innerText = "Cooldown Upgrade Level: " + userData.cooldownLevel;
                document.getElementById("luckLevelDisplay").innerText = "Luck Upgrade Level: " + userData.luckUpgradeLevel;

                let currentCooldown = Math.max(baseCooldown - userData.cooldownLevel * cooldownReduction, minCooldown);
                if (speedBoostActive) currentCooldown = Math.max(currentCooldown * 0.8, minCooldown);
                document.getElementById("currentCooldownDisplay").innerText = "Current Roll Cooldown: " + (currentCooldown / 1000).toFixed(1) + "s";

                document.getElementById("playerScoreDisplay").innerText = "Player Score: " + userData.playerScore;

                // Update potion counts
                document.getElementById("luckPotionCount").innerText = userData.potions.luck;
                document.getElementById("speedPotionCount").innerText = userData.potions.speed;
                document.getElementById("battlePotionCount").innerText = userData.potions.battle;

                // Update boost statuses
                let boostText = "";
                if (luckActive) boostText += `Luck Boost Active: ${luckTimeRemaining}s remaining. `;
                if (speedBoostActive) boostText += `Speed Boost Active: ${speedTimeRemaining}s remaining. `;
                document.getElementById("boostStatus").innerText = boostText;
                document.getElementById("potionStatus").innerText = battleBoostActive ? "Battle Boost Active for next battle!" : "";

                // Update inventory, deck, and appraisal UIs
                updateInventoryUI();
                updateDeckUI();
                updateAppraisalUI();

                // Update leaderboard and daily challenge UIs
                updateLeaderboardUI();
                updateDailyChallengeUI();

                // Update user header
                updateUserHeader();

                // Save user data
                saveUserData();
            }

            function updateInventoryUI(filteredItems = userData.inventory) {
                let invList = document.getElementById("inventoryList");
                invList.innerHTML = "";
                filteredItems.forEach((item) => {
                    let li = document.createElement("li");
                    li.innerHTML = `<strong>${item.name}</strong> (${item.rarity.toUpperCase()}) - Value: ${item.value}<br>
                                Grade: ${item.grade}, Quality: ${item.quality}<br>
                                <em>${item.description}</em><br>
                                Stats: ATK ${item.attack}, DEF ${item.defense}<br>
                                Ability: ${item.ability.description}<br>
                                <button onclick="sellItem('${item.id}', event)">Sell</button>`;
                    invList.appendChild(li);
                });
            }

            function filterRarities() {
                const selectedRarity = document.getElementById("rarityFilter").value;
                if (selectedRarity) {
                    const filteredItems = userData.inventory.filter(card => card.rarity === selectedRarity);
                    updateInventoryUI(filteredItems);
                } else {
                    updateInventoryUI();
                }
            }

            function updateDeckUI() {
                let deckListEl = document.getElementById("deckList");
                let deckInventoryEl = document.getElementById("deckInventoryList");
                deckListEl.innerHTML = "";
                deckInventoryEl.innerHTML = "";
                (userData.deck || []).forEach(card => {
                    let li = document.createElement("li");
                    li.innerHTML = `<strong>${card.name}</strong> (${card.rarity.toUpperCase()})<br>
                                Grade: ${card.grade}, Quality: ${card.quality}<br>
                                Stats: ATK ${card.attack}, DEF ${card.defense}<br>
                                Ability: ${card.ability.description}
                                 <button onclick="removeFromDeck('${card.id}')">Remove</button>`;
                    deckListEl.appendChild(li);
                });
                (userData.inventory || []).forEach(card => {
                    let inDeck = (userData.deck || []).some(deckCard => deckCard.id === card.id);
                    if (!inDeck) {
                        let li = document.createElement("li");
                        li.innerHTML = `<strong>${card.name}</strong> (${card.rarity.toUpperCase()})<br>
                                    Grade: ${card.grade}, Quality: ${card.quality}<br>
                                    Stats: ATK ${card.attack}, DEF ${card.defense}<br>
                                    Ability: ${card.ability.description}
                                     <button onclick="addToDeck('${card.id}')">Add to Deck</button>`;
                        deckInventoryEl.appendChild(li);
                    }
                });
            }

            function updateAppraisalUI() {
                let appraisalList = document.getElementById("appraisalList");
                appraisalList.innerHTML = "";
                (userData.inventory || []).forEach(card => {
                    let li = document.createElement("li");
                    li.innerHTML = `<strong>${card.name}</strong> (${card.rarity.toUpperCase()}) - Current Value: ${card.value}<br>
                                Grade: ${card.grade}, Quality: ${card.quality}<br>
                                <em>${card.description}</em><br>
                                Stats: ATK ${card.attack}, DEF ${card.defense}<br>
                                Ability: ${card.ability.description}<br>
                                <button onclick="appraiseCard('${card.id}')">Appraise (Cost: 500 Coins)</button>`;
                    appraisalList.appendChild(li);
                });
            }

            function updateLeaderboardUI() {
                let leaderboardData = [];
                const storedLeaderboard = localStorage.getItem("leaderboardData");
                if (storedLeaderboard) {
                    leaderboardData = JSON.parse(storedLeaderboard);
                } else {
                    leaderboardData = [{
                            name: "Alice",
                            score: 1000
                        },
                        {
                            name: "Bob",
                            score: 750
                        },
                        {
                            name: "Charlie",
                            score: 500
                        }
                    ];
                }
                let found = false;
                for (let i = 0; i < leaderboardData.length; i++) {
                    if (leaderboardData[i].name === currentUser) {
                        leaderboardData[i].score = userData.playerScore;
                        found = true;
                        break;
                    }
                }
                if (!found) leaderboardData.push({
                    name: currentUser,
                    score: userData.playerScore
                });
                leaderboardData.sort((a, b) => b.score - a.score);
                let lbList = document.getElementById("leaderboardList");
                lbList.innerHTML = "";
                leaderboardData.forEach((entry, index) => {
                    let li = document.createElement("li");
                    li.innerText = `${index + 1}. ${entry.name} - Score: ${entry.score}`;
                    lbList.appendChild(li);
                });
                localStorage.setItem("leaderboardData", JSON.stringify(leaderboardData));
            }

            function updateDailyChallengeUI() {
                let dailyInfo = document.getElementById("dailyChallengeInfo");
                const dc = userData.dailyChallenge;
                dailyInfo.innerHTML = `<p>${dc.description}</p>
                                   <p>Wins: ${dc.wins} / ${dc.target}</p>`;
                let claimBtn = document.getElementById("claimDailyChallengeBtn");
                if (dc.wins >= dc.target && !dc.claimed) {
                    claimBtn.style.display = "inline-block";
                } else {
                    claimBtn.style.display = "none";
                }
            }

            // ---------------- Card Operations --------------------------
            function assignCardId(card) {
                globalCardId++;
                card.id = globalCardId.toString();
                return card;
            }

            // Roll for a card.
            document.getElementById("rollButton").addEventListener("click", function () {
                if (isRolling) return;
                rollForCard();
            });

            function rollForCard() {
                isRolling = true;
                document.getElementById("rollButton").disabled = true;
                if (rollSound) {
                    rollSound.currentTime = 0;
                    rollSound.play();
                }

                // Determine probabilities based on active potions
                let probs = baseProbs;
                if (luckActive) {
                    for (let rarity in probs) {
                        probs[rarity] *= 1.1; // Increase probabilities by 10%
                    }
                }

                // Roll probabilities
                let total = 0;
                for (let key in probs) total += probs[key];
                let rollRandom = Math.random() * total;
                let cumulative = 0,
                    chosenRarity = "";
                for (let rarity in probs) {
                    cumulative += probs[rarity];
                    if (rollRandom <= cumulative) {
                        chosenRarity = rarity;
                        break;
                    }
                }
                let group = items[chosenRarity];
                let item = group[getRandomInt(0, group.length - 1)];
                let newItem = Object.assign({}, item);
                assignCardId(newItem);

                // Generate random grade and quality for the new card
                newItem.grade = grades[getRandomInt(0, grades.length - 1)];
                newItem.quality = qualities[getRandomInt(0, qualities.length - 1)];

                // Apply multipliers based on randomly generated grade and quality
                const gradeMultiplier = gradeMultipliers[newItem.grade];
                const qualityMultiplier = qualityMultipliers[newItem.quality];

                newItem.attack = Math.floor(item.attack * gradeMultiplier * qualityMultiplier);
                newItem.defense = Math.floor(item.defense * gradeMultiplier * qualityMultiplier);

                userData.inventory.push(newItem);
                displayRollResult(newItem);
                let currentCooldown = Math.max(baseCooldown - userData.cooldownLevel * cooldownReduction, minCooldown);
                if (speedBoostActive) currentCooldown = Math.max(currentCooldown * 0.8, minCooldown);
                let remaining = currentCooldown / 1000;
                document.getElementById("cooldownTimer").innerText = "Cooldown: " + remaining.toFixed(1) + "s";
                let cooldownInterval = setInterval(function () {
                    remaining -= 0.1;
                    if (remaining <= 0) {
                        clearInterval(cooldownInterval);
                        document.getElementById("cooldownTimer").innerText = "";
                        document.getElementById("rollButton").disabled = false;
                        isRolling = false;
                    } else {
                        document.getElementById("cooldownTimer").innerText = "Cooldown: " + remaining.toFixed(1) + "s";
                    }
                }, 100);
                updateUI();
            }

            function displayRollResult(item) {
                const rarityColors = {
                    common: "#BBBBBB",
                    uncommon: "#00FF00",
                    rare: "#0000FF",
                    epic: "#800080",
                    legendary: "#FFA500",
                    mythic: "#FF4500",
                    divine: "#FFD700",
                    cosmic: "#FF0000",
                    eternal: "#00CED1",
                    celestial: "#FF69B4",
                    transcendent: "#8A2BE2",
                    godly: "#9A6324",
                    extreme: "#800000",
                    solar: "#FF6347",
                    galactic: "#483D8B",
                    universal: "#2F4F4F",
                    mythos: "#A52A2A",
                    primal: "#FF1493",
                    ethereal: "#8B0000",
                    restricted: "#556B2F"
                };
                let rollResult = document.getElementById("rollResult");
                rollResult.innerHTML = `
                    <div class="card" id="itemCard">
                        <div class="card-inner">
                            <div class="card-front">
                                <span style="color:${rarityColors[item.rarity]}; font-weight:bold;">${item.name}</span>
                                (${item.rarity.toUpperCase()})<br>
                                <em>${item.description}</em><br>
                                Value: ${item.value}<br>
                                Stats: ATK ${item.attack} / DEF ${item.defense}<br>
                                Grade: ${item.grade}, Quality: ${item.quality}
                            </div>
                            <div class="card-back">
                                <strong>Ability:</strong> ${item.ability.description}
                            </div>
                        </div>
                    </div>
                `;
                let flipBtn = document.getElementById("flipCardBtn");
                flipBtn.style.display = "inline-block";
                flipBtn.onclick = function () {
                    let card = document.getElementById("itemCard");
                    card.classList.toggle("flipped");
                };
            }

            // Sell item from inventory.
            window.sellItem = function (cardId, event) {
                let index = userData.inventory.findIndex(item => item.id === cardId);
                if (index === -1) return;
                let item = userData.inventory[index];
                if (sellSound) {
                    sellSound.currentTime = 0;
                    sellSound.play();
                }

                userData.currency += item.value;
                userData.playerScore += item.value;
                removeFromDeck(cardId);
                userData.inventory.splice(index, 1);
                updateUI();
            };

            // Appraisal: deduct 500 coins; increase value by 50%; with 50% chance, upgrade one grade and 50% chance one quality.
            window.appraiseCard = function (cardId) {
                if (userData.currency < 500) {
                    alert("Not enough coins to appraise!");
                    return;
                }
                let card = userData.inventory.find(item => item.id === cardId);
                if (!card) return;
                userData.currency -= 500;
                let oldValue = card.value;
                card.value = Math.floor(card.value * 1.5);
                // Attempt grade upgrade (50% chance).
                let currentGradeIndex = grades.indexOf(card.grade);
                if (currentGradeIndex < grades.length - 1 && Math.random() < 0.5) {
                    let newGrade = grades[currentGradeIndex + 1];
                    alert(`${card.name} grade upgraded from ${card.grade} to ${newGrade}!`);
                    card.grade = newGrade;
                }
                // Attempt quality upgrade (50% chance).
                let currentQualityIndex = qualities.indexOf(card.quality);
                if (currentQualityIndex < qualities.length - 1 && Math.random() < 0.5) {
                    let newQuality = qualities[currentQualityIndex + 1];
                    alert(`${card.name} quality improved from ${card.quality} to ${newQuality}!`);
                    card.quality = newQuality;
                }
                alert(`Appraisal successful! ${card.name} value increased from ${oldValue} to ${card.value}.`);
                updateUI();
            };

            // ---------------- Deck Builder Functions ------------------------
            window.addToDeck = function (cardId) {
                if ((userData.deck || []).length >= 5) {
                    alert("Deck is full! Maximum 5 cards allowed.");
                    return;
                }
                let card = (userData.inventory || []).find(item => item.id === cardId);
                if (!card) return;
                if ((userData.deck || []).some(c => c.id === cardId)) return;
                userData.deck.push(card);
                updateUI();
            };

            window.removeFromDeck = function (cardId) {
                if (!userData.deck) return;
                userData.deck = userData.deck.filter(c => c.id !== cardId);
                updateUI();
            };

            // ---------------- Upgrades & Potions -----------------------
            document.getElementById("upgradeCooldownBtn").addEventListener("click", function () {
                let cost = 50 * (userData.cooldownLevel + 1);
                if (userData.currency >= cost) {
                    userData.currency -= cost;
                    userData.cooldownLevel++;
                    updateUI();
                    alert("Roll cooldown upgraded!");
                } else {
                    alert("Not enough coins for cooldown upgrade!");
                }
            });

            document.getElementById("upgradeLuckBtn").addEventListener("click", function () {
                let cost = 100 * (userData.luckLevel + 1);
                if (userData.currency >= cost) {
                    userData.currency -= cost;
                    userData.luckLevel++;
                    updateUI();
                    alert("Luck upgraded!");
                } else {
                    alert("Not enough coins for luck upgrade!");
                }
            });

            document.getElementById("buyLuckPotionBtn").addEventListener("click", function () {
                let cost = 100;
                if (userData.currency >= cost) {
                    userData.currency -= cost;
                    userData.potions.luck++;
                    updateUI();
                } else {
                    alert("Not enough coins to buy Luck Potion!");
                }
            });

            document.getElementById("useLuckPotionBtn").addEventListener("click", function () {
                if (userData.potions.luck > 0 && !luckActive) {
                    userData.potions.luck--;
                    activateLuck();
                    alert("Luck Potion used!");
                } else if (luckActive) {
                    alert("Luck boost already active!");
                } else {
                    alert("No Luck Potions available!");
                }
            });

            document.getElementById("buySpeedPotionBtn").addEventListener("click", function () {
                let cost = 120;
                if (userData.currency >= cost) {
                    userData.currency -= cost;
                    userData.potions.speed++;
                    updateUI();
                } else {
                    alert("Not enough coins to buy Speed Potion!");
                }
            });

            document.getElementById("useSpeedPotionBtn").addEventListener("click", function () {
                if (userData.potions.speed > 0 && !speedBoostActive) {
                    userData.potions.speed--;
                    activateSpeed();
                    alert("Speed Potion used!");
                } else if (speedBoostActive) {
                    alert("Speed boost already active!");
                } else {
                    alert("No Speed Potions available!");
                }
            });

            document.getElementById("buyBattlePotionBtn").addEventListener("click", function () {
                let cost = 150;
                if (userData.currency >= cost) {
                    userData.currency -= cost;
                    userData.potions.battle++;
                    updateUI();
                } else {
                    alert("Not enough coins to buy Battle Potion!");
                }
            });

            document.getElementById("useBattlePotionBtn").addEventListener("click", function () {
                if (userData.potions.battle > 0 && !battleBoostActive) {
                    userData.potions.battle--;
                    battleBoostActive = true;
                    updateUI();
                    alert("Battle boost activated for next battle!");
                } else if (battleBoostActive) {
                    alert("Battle boost already active!");
                } else {
                    alert("No Battle Potions available!");
                }
            });

            function activateLuck() {
                luckActive = true;
                luckTimeRemaining = boostDuration;
                updateUI();
                luckTimerInterval = setInterval(function () {
                    luckTimeRemaining--;
                    if (luckTimeRemaining <= 0) {
                        clearInterval(luckTimerInterval);
                        luckActive = false;
                        alert("Luck boost has ended!");
                        updateUI();
                    }
                }, 1000);
            }

            function activateSpeed() {
                speedBoostActive = true;
                speedTimeRemaining = boostDuration;
                updateUI();
                speedTimerInterval = setInterval(function () {
                    speedTimeRemaining--;
                    if (speedTimeRemaining <= 0) {
                        clearInterval(speedTimerInterval);
                        speedBoostActive = false;
                        alert("Speed boost has ended!");
                        updateUI();
                    }
                }, 1000);
            }

            // ---------------- Cases ----------------------------
            const baseCaseProbabilities = {
                basic: {
                    common: 50,
                    uncommon: 30,
                    rare: 15,
                    epic: 5
                },
                premium: {
                    uncommon: 40,
                    rare: 30,
                    epic: 20,
                    legendary: 10
                },
                ultra: {
                    rare: 40,
                    epic: 30,
                    legendary: 20,
                    mythic: 10
                },
                elite: {
                    epic: 40,
                    legendary: 30,
                    mythic: 20,
                    divine: 10
                },
                legendary: {
                    legendary: 40,
                    mythic: 30,
                    divine: 20,
                    cosmic: 10
                }
            };

            document.getElementById("openBasicCaseBtn").addEventListener("click", function () {
                openCase(baseCaseProbabilities.basic, "Basic Case");
            });

            document.getElementById("openPremiumCaseBtn").addEventListener("click", function () {
                openCase(baseCaseProbabilities.premium, "Premium Case");
            });

            document.getElementById("openUltraCaseBtn").addEventListener("click", function () {
                openCase(baseCaseProbabilities.ultra, "Ultra Case");
            });

            document.getElementById("openEliteCaseBtn").addEventListener("click", function () {
                openCase(baseCaseProbabilities.elite, "Elite Case");
            });

            document.getElementById("openLegendaryCaseBtn").addEventListener("click", function () {
                openCase(baseCaseProbabilities.legendary, "Legendary Case");
            });

            function openCase(probabilities, caseType) {
                const caseAnimation = document.getElementById("caseAnimation");
                const caseResult = document.getElementById("caseResult");
                caseResult.innerHTML = ""; // Clear previous result

                // Create spinning animation
                const spinAnimation = caseAnimation.animate([
                    { transform: 'rotateY(0deg)' }, 
                    { transform: 'rotateY(360deg)' }
                ], {
                    duration: 2000,
                    easing: 'linear'
                });

                // Prepare items for animation
                const animationItems = [];
                for (let i = 0; i < 20; i++) { // Create 20 items for the animation
                    let rarity = chooseRarity(probabilities);
                    let item = getRandomItem(rarity);
                    animationItems.push(item);
                }

                // Add items to animation container
                caseAnimation.innerHTML = animationItems.map(item => `<div class="item">${item.name}</div>`).join('');

                // Choose winning item
                let winningRarity = chooseRarity(probabilities);
                let winningItem = getRandomItem(winningRarity);
                assignCardId(winningItem);

                // Determine if a potion will drop
                let dropPotion = Math.random() < 0.3; // 30% chance of potion drop
                let potionType;
                if (dropPotion) {
                    potionType = Object.keys(potionProbabilities)[getRandomInt(0, Object.keys(potionProbabilities).length - 1)];
                }

                // Run animation
                setTimeout(() => {
                    spinAnimation.cancel();
                    // Animation complete callback
                    if (dropPotion) {
                        userData.potions[potionType] = (userData.potions[potionType] || 0) + 1;
                        caseResult.innerHTML = `<p>You won a ${winningItem.name} and a ${potionType} potion!</p>`;
                    } else {
                        userData.inventory.push(winningItem);
                        caseResult.innerHTML = `<p>You opened a ${winningItem.name} from the ${caseType}!</p>`;
                    }
                    updateUI();
                }, 2000);
            }

            function chooseRarity(probabilities) {
                let total = 0;
                for (let key in probabilities) {
                    total += probabilities[key];
                }
                let rollRandom = Math.random() * total;
                let cumulative = 0,
                    chosenRarity = "";
                for (let rarity in probabilities) {
                    cumulative += probabilities[rarity];
                    if (rollRandom <= cumulative) {
                        chosenRarity = rarity;
                        break;
                    }
                }
                return chosenRarity;
            }

            function getRandomItem(rarity) {
                let group = items[rarity];
                return Object.assign({}, group[getRandomInt(0, group.length - 1)]); // Return a copy
            }

            // ---------------- Battle System: Turn-Based Deck Battles -------------------
            document.getElementById("startBattleBtn").addEventListener("click", function () {
                startBattle();
            });

            function startBattle() {
                if (!userData.deck || userData.deck.length === 0) {
                    alert("Your deck is empty! Build your deck in the Deck Builder tab.");
                    return;
                }
                let deckSize = userData.deck.length;

                // Determine enemy difficulty based on player's deck
                let playerTotalStats = userData.deck.reduce((acc, card) => acc + card.attack + card.defense, 0);
                let enemyDifficulty = Math.min(playerTotalStats, 500); // Cap difficulty

                // Generate enemy deck of the same size, scaling with difficulty
                let enemyDeck = [];
                for (let i = 0; i < deckSize; i++) {
                    let enemyRarity = chooseEnemyRarity(enemyDifficulty);
                    let enemyCard = getRandomItem(enemyRarity);
                    enemyDeck.push(enemyCard);
                }

                // Prepare battle decks (add HP and set revival flags).
                let playerBattleDeck = userData.deck.map(card => {
                    let battleCard = Object.assign({}, card);
                    battleCard.hp = card.attack + card.defense;
                    battleCard.maxHp = battleCard.hp;
                    battleCard.revived = false;
                    return battleCard;
                });
                let enemyBattleDeck = enemyDeck.map(card => {
                    let battleCard = Object.assign({}, card);
                    battleCard.hp = card.attack + card.defense;
                    battleCard.maxHp = battleCard.hp;
                    battleCard.revived = false;
                    return battleCard;
                });

                const turnLog = document.getElementById("turnLog");
                turnLog.innerText = "";

                let round = 1;
                let gameActive = true;

                function executeTurn() {
                    if (!gameActive) return;

                    let playerCard = playerBattleDeck[0];
                    let enemyCard = enemyBattleDeck[0];

                    // Player attacks enemy
                    let playerDamage = playerCard.attack;
                    enemyCard.hp -= playerDamage;
                    turnLog.innerText += `Round ${round}: ${playerCard.name} attacks ${enemyCard.name} for ${playerDamage} damage!\n`;

                    if (enemyCard.hp <= 0) {
                        enemyBattleDeck.shift(); // Remove enemy card if defeated
                        turnLog.innerText += `${enemyCard.name} has been defeated!\n`;
                    }

                    // Enemy attacks player if still alive
                    if (enemyCard.hp > 0) {
                        let enemyDamage = enemyCard.attack;
                        playerCard.hp -= enemyDamage;
                        turnLog.innerText += `${enemyCard.name} attacks ${playerCard.name} for ${enemyDamage} damage!\n`;

                        if (playerCard.hp <= 0) {
                            playerBattleDeck.shift(); // Remove player card if defeated
                            turnLog.innerText += `${playerCard.name} has been defeated!\n`;
                        }
                    }

                    // Check if the battle is over
                    if (playerBattleDeck.length === 0 || enemyBattleDeck.length === 0) {
                        gameActive = false;
                        let winner = playerBattleDeck.length > 0 ? "Player" : "Enemy";
                        turnLog.innerText += `${winner} has won the battle!\n`;
                    } else {
                        round++;
                        document.getElementById("nextTurnBtn").style.display = "block"; 
                    }
                }

                document.getElementById("nextTurnBtn").onclick = function () {
                    executeTurn();
                };

                updateUI();
                executeTurn();
            }

            // Function to choose enemy rarity based on difficulty
            function chooseEnemyRarity(difficulty) {
                // Scale probabilities based on difficulty
                let probs = {
                    common: Math.max(0, 50 - difficulty * 0.1),
                    uncommon: Math.max(0, 30 - difficulty * 0.05),
                    rare: Math.max(0, 15 - difficulty * 0.02),
                    epic: Math.max(0, 5 - difficulty * 0.01),
                    legendary: Math.max(0, 0 - difficulty * 0.005),
                    mythic: Math.max(0, 0 - difficulty * 0.001)
                };

                // Ensure probabilities are not negative
                for (let key in probs) {
                    probs[key] = Math.max(0, probs[key]);
                }

                // Normalize probabilities
                let total = Object.values(probs).reduce((a, b) => a + b, 0);
                if (total === 0) return "common"; // Default to common if all are zero

                let roll = Math.random() * total;
                let cumulative = 0;
                for (let rarity in probs) {
                    cumulative += probs[rarity];
                    if (roll <= cumulative) {
                        return rarity;
                    }
                }
                return "common"; // Fallback
            }

            // Function to calculate reward based on difficulty and rounds survived
            function calculateReward(enemyDifficulty, roundsSurvived, won) {
                let baseReward = 50;
                let difficultyBonus = enemyDifficulty * 0.2;
                let survivalBonus = roundsSurvived * 2;
                let winBonus = won ? 50 : 0;

                let totalReward = baseReward + difficultyBonus + survivalBonus + winBonus;
                return Math.floor(totalReward);
            }

            // ---------------- Deep Battle Mechanics: Turn-Based Duel Simulation -----------------------
            function simulateDuel(playerCard, enemyCard) {
                let log = "";
                while (playerCard.hp > 0 && enemyCard.hp > 0) {
                    // Player attacks enemy.
                    let damage = playerCard.attack;
                    if (playerCard.rarity === "cosmic" && Math.random() < 0.2) {
                        damage *= 2;
                        log += `Cosmic Critical! ${playerCard.name} deals double damage.\n`;
                    }
                    enemyCard.hp -= damage;
                    log += `${playerCard.name} attacks ${enemyCard.name} for ${damage} damage. (Enemy HP: ${Math.max(enemyCard.hp, 0)})\n`;

                    // Check enemy defeat and Celestial revival.
                    if (enemyCard.hp <= 0) {
                        if (enemyCard.rarity === "celestial" && !enemyCard.revived) {
                            enemyCard.hp = Math.floor(enemyCard.maxHp / 2);
                            enemyCard.revived = true;
                            log += `${enemyCard.name} is revived with ${enemyCard.hp} HP due to Celestial ability!\n`;
                        } else {
                            break;
                        }
                    }

                    // Enemy attacks player.
                    damage = enemyCard.attack;
                    if (enemyCard.rarity === "cosmic" && Math.random() < 0.2) {
                        damage *= 2;
                        log += `Cosmic Critical! ${enemyCard.name} deals double damage.\n`;
                    }
                    playerCard.hp -= damage;
                    log += `${enemyCard.name} attacks ${playerCard.name} for ${damage} damage. (Player HP: ${Math.max(playerCard.hp, 0)})\n`;

                    // Check player defeat and Celestial revival.
                    if (playerCard.hp <= 0) {
                        if (playerCard.rarity === "celestial" && !playerCard.revived) {
                            playerCard.hp = Math.floor(playerCard.maxHp / 2);
                            playerCard.revived = true;
                            log += `${playerCard.name} is revived with ${playerCard.hp} HP due to Celestial ability!\n`;
                        } else {
                            break;
                        }
                    }

                    // Extra turn for Eternal ability: 10% chance.
                    if (playerCard.rarity === "eternal" && Math.random() < 0.1) {
                        log += `${playerCard.name} gets an extra turn due to Eternal ability!\n`;
                        continue; // Repeat player attack
                    }
                }
                let winner = (playerCard.hp > 0) ? "player" : "enemy";
                let remainingHp = (playerCard.hp > 0) ? playerCard.hp : enemyCard.hp;
                return {
                    winner: winner,
                    remainingHp: remainingHp,
                    log: log
                };
            }

            // ---------------- Daily Challenge Functions -----------------------
            document.getElementById("generateNewChallengeBtn").addEventListener("click", function () {
                const randomWinsTarget = Math.floor(Math.random() * 3) + 3; // Random wins between 3 to 5
                userData.dailyChallenge = {
                    description: `Win ${randomWinsTarget} battles.`,
                    wins: 0,
                    target: randomWinsTarget,
                    reward: randomWinsTarget * 50,
                    claimed: false
                };
                updateDailyChallengeUI();
            });

            document.getElementById("claimDailyChallengeBtn").addEventListener("click", function () {
                if (userData.dailyChallenge && userData.dailyChallenge.wins >= userData.dailyChallenge.target && !userData.dailyChallenge.claimed) {
                    userData.currency += userData.dailyChallenge.reward;
                    userData.playerScore += userData.dailyChallenge.reward;
                    userData.dailyChallenge.claimed = true;
                    alert(`Daily challenge completed! You received ${userData.dailyChallenge.reward} coins.`);
                    updateUI();
                }
            });

            // ---------------- Tab Switching Functionality -----------------------
            window.showTab = function (tabName) {
                let tabs = document.getElementsByClassName("tabContent");
                for (let i = 0; i < tabs.length; i++) {
                    tabs[i].classList.remove("active");
                }
                document.getElementById(tabName + "Content").classList.add("active");
                let tabButtons = document.getElementsByClassName("tabButton");
                for (let i = 0; i < tabButtons.length; i++) {
                    tabButtons[i].classList.remove("active");
                }
                document.getElementById(tabName + "Tab").classList.add("active");
            };

            // ---------------- Initialize UI -----------------------
            updateUI();
        });
    </script>
</body>

</html>